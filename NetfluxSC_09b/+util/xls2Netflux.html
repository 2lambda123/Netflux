<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of xls2Netflux</title>
  <meta name="keywords" content="xls2Netflux">
  <meta name="description" content="Reads the Netflux Excel spreadsheet and converts them to NH equations">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">NetfluxSC_09b</a> &gt; <a href="index.html">+util</a> &gt; xls2Netflux.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for NetfluxSC_09b\+util&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>xls2Netflux
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Reads the Netflux Excel spreadsheet and converts them to NH equations</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [specID,reactionIDs,reactionRules,paramList,ODElist,CNAmodel, ReadError]=xls2Netflux(networkID,xlsfilename) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Reads the Netflux Excel spreadsheet and converts them to NH equations

 Converts an Excel spreadsheet of specified format into a NH differential
 equation system version version 0.08a, last modified 08/30/2011 by JJS
 
 Notes:
   1) xls2Netflux makes a number of assumptions about the xlsfile
   structure
       and will throw errors if there are problem: 'species' sheet: ID's
       in column B, starting in row 3, names in column C 'reactions'
       sheet: ID's in column B starting in row 3, CNA rule in column C
 Dependencies: cna2Netflux load XLS network reconstruction and read
 species, reaction rules</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [specID,reactionIDs,reactionRules,paramList,ODElist,CNAmodel, ReadError]=xls2Netflux(networkID,xlsfilename)</a>
0002 <span class="comment">% Reads the Netflux Excel spreadsheet and converts them to NH equations</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Converts an Excel spreadsheet of specified format into a NH differential</span>
0005 <span class="comment">% equation system version version 0.08a, last modified 08/30/2011 by JJS</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% Notes:</span>
0008 <span class="comment">%   1) xls2Netflux makes a number of assumptions about the xlsfile</span>
0009 <span class="comment">%   structure</span>
0010 <span class="comment">%       and will throw errors if there are problem: 'species' sheet: ID's</span>
0011 <span class="comment">%       in column B, starting in row 3, names in column C 'reactions'</span>
0012 <span class="comment">%       sheet: ID's in column B starting in row 3, CNA rule in column C</span>
0013 <span class="comment">% Dependencies: cna2Netflux load XLS network reconstruction and read</span>
0014 <span class="comment">% species, reaction rules</span>
0015 
0016 <span class="keyword">global</span> statusLabel
0017 <span class="keyword">if</span> ~exist(<span class="string">'xlsfilename'</span>,<span class="string">'var'</span>)
0018     [fname,pathname,filterindex]=uigetfile(<span class="string">'*.xls;*.xlsx'</span>,<span class="string">'Open XLS network reconstruction'</span>);
0019     xlsfilename = [pathname fname];
0020 <span class="keyword">end</span>
0021 pathname = strrep(xlsfilename,[networkID <span class="string">'.xls'</span>],<span class="string">''</span>); 
0022 warning off MATLAB:xlsread:Mode;
0023 
0024 [~,speciesSheetTxt,raw]=xlsread(xlsfilename,<span class="string">'species'</span>,<span class="string">''</span>,<span class="string">'basic'</span>); <span class="comment">%reason for speciesSheetNum and reactionSheetNum? - In order to get to the Txt, need to get to the Num first</span>
0025 
0026 specID = strtrim(speciesSheetTxt(3:<span class="keyword">end</span>,2)); <span class="comment">% Species ID in column B; 3:end specifies rows, 2 specifies column</span>
0027 specNames = speciesSheetTxt(3:<span class="keyword">end</span>,3); <span class="comment">% Species Name in column C</span>
0028 
0029 <span class="comment">% delete species with no specID</span>
0030 noValue = cellfun(@isempty,specID);
0031 specID(noValue) = [];
0032 specNames(noValue) = [];
0033 
0034 numSpecs = length(specID);
0035 
0036 <span class="comment">% This error is caused by an error in XLSread in basic mode.</span>
0037 <span class="keyword">if</span> numSpecs == 0
0038     error(<span class="string">'SpeciesError:NoSpecies'</span>,<span class="string">'Number of species is zero, check spreadsheet or try saving as .xlsx'</span>);
0039 <span class="keyword">end</span>
0040 
0041 varError = {};
0042 eIndex = {};
0043 <span class="keyword">try</span>
0044     specErrs = {};
0045     <span class="keyword">for</span> i = 1:length(specID)
0046         <span class="keyword">if</span> ~isvarname(char(specID(i)))
0047             eIndex{end+1} = i;
0048         <span class="keyword">end</span>
0049     <span class="keyword">end</span>
0050     <span class="keyword">if</span> ~isempty(eIndex)
0051         error(<span class="string">'SpeciesError:Syntax'</span>, <span class="string">'Species names must begin with letter and contain only letters, numbers, and underscores'</span>)
0052     <span class="keyword">end</span>
0053 <span class="keyword">catch</span>
0054     eIndex = cell2mat(eIndex);
0055     <span class="keyword">for</span> i = 1:length(eIndex)
0056         varError{end+1} = sprintf(specID{eIndex(i)});
0057     <span class="keyword">end</span>
0058 <span class="keyword">end</span>
0059 
0060 [~,reactionsSheetTxt,reactionsSheetRaw]=xlsread(xlsfilename,<span class="string">'reactions'</span>,<span class="string">''</span>,<span class="string">'basic'</span>);
0061 reactionIDs = reactionsSheetTxt(3:<span class="keyword">end</span>,2); <span class="comment">%Start Row 3, Column B</span>
0062 reactionRules = reactionsSheetTxt(3:<span class="keyword">end</span>,3); <span class="comment">%Start Row 3, Column C</span>
0063 
0064 <span class="comment">% remove reaction and ID from respective lists if reaction rules aren't</span>
0065 <span class="comment">% present, if rules present but no ID, nothing is changed.</span>
0066 noRules = cellfun(@isempty, reactionRules);
0067 reactionRules(noRules) = [];
0068 reactionIDs(noRules) = [];
0069 
0070 numRcns = length(reactionIDs);
0071 interMat = zeros(numSpecs,numRcns);
0072 notMat = zeros(numSpecs,numRcns);
0073 
0074 <span class="comment">% error is empty string if no error</span>
0075 XLSerror = [<span class="string">''</span>];
0076 
0077 <span class="comment">% create cell arrays to hold error messages so they can all be</span>
0078 <span class="comment">% concatenated and sent to the GUI after every reaction has been read.</span>
0079 mismatchErrs = {};
0080 NoProductsErrs = {};
0081 NoReactantsErrs = {};
0082 ArrowErrs = {};
0083 DuplicateErrs = {};
0084 
0085 <span class="comment">% Determine if there are duplicate reactions in the .xls file.</span>
0086 <span class="keyword">try</span>
0087     <span class="keyword">if</span> length(unique(reactionRules)) &lt; length(reactionRules)
0088         error(<span class="string">'DuplicateError:DuplicateReaction'</span>, <span class="string">'Duplicate reaction in reactions sheet'</span>);
0089     <span class="keyword">end</span>
0090 <span class="keyword">catch</span>
0091     <span class="comment">% find the indices of the repeats using the returned values from repval</span>
0092     [duplicates, numRepeat, ind] = util.repval(reactionRules);
0093     [duplicates, numRepeat, ind] = util.repval(reactionRules);
0094     <span class="keyword">for</span> i = 1:length(duplicates)
0095         <span class="keyword">for</span> j = 1:numRepeat(i)
0096             <span class="keyword">if</span> i == 1
0097                 ids{i,j} = ind(j);
0098             <span class="keyword">else</span>
0099                 ids{i,j} = ind(sum(numRepeat(1:i-1)) + j);
0100             <span class="keyword">end</span>
0101         <span class="keyword">end</span>
0102     <span class="keyword">end</span>
0103     <span class="comment">% create error string from reaction rules and repval duplicates</span>
0104     DuplicateErrs = {};
0105     <span class="keyword">for</span> i = 1:length(duplicates)
0106         idstr = <span class="string">''</span>;
0107         j = 1;
0108         <span class="keyword">while</span> j &lt;= length(ids(i,:)) &amp;&amp; ~isempty(cell2mat(ids(i,j)))
0109             <span class="keyword">if</span> j &gt; 1
0110                 idstr = sprintf(horzcat(idstr, <span class="string">'/'</span>,char(reactionIDs(ids{i,j}))));
0111             <span class="keyword">else</span>
0112                 idstr = sprintf(horzcat(idstr, char(reactionIDs(ids{i,j}))));
0113             <span class="keyword">end</span>
0114             j = j+1;
0115         <span class="keyword">end</span>
0116         DuplicateErrs{end+1} = sprintf([idstr, <span class="string">': '</span>, duplicates{i}]);
0117     <span class="keyword">end</span>
0118 <span class="keyword">end</span>
0119 
0120 <span class="keyword">for</span> i=1:numRcns
0121     <span class="keyword">try</span>
0122     <span class="comment">% calculate interMat column for reaction 'i'</span>
0123     specIDReg = cellfun(@(x) [<span class="string">'\&lt;'</span>,x,<span class="string">'\&gt;'</span>],specID,<span class="string">'UniformOutput'</span>,false); <span class="comment">% match must be the entire word</span>
0124     rxnSpecies = regexp(reactionRules{i},specIDReg); 
0125     
0126     <span class="keyword">if</span> isempty(cell2mat(rxnSpecies))
0127         error(<span class="string">'RxnSyntax:NoSpeciesMatch'</span>, <span class="string">'No species recognized in reaction'</span>);
0128     <span class="keyword">end</span>
0129     
0130     eqPos = findstr(<span class="string">'=&gt;'</span>,reactionRules{i});
0131     
0132     <span class="comment">% display error if no equal position detected</span>
0133     <span class="keyword">if</span> isempty(eqPos)
0134         error(<span class="string">'RxnSyntax:NoReactionArrow'</span>, <span class="string">'No reaction arrow was detected, check syntax'</span>);
0135     <span class="keyword">end</span>
0136     
0137     reactants =-1* cellfun(@(x) ~isempty(x) &amp;&amp; x&lt;eqPos,rxnSpecies);
0138     products = cellfun(@(x) ~isempty(x) &amp;&amp; x&gt;eqPos,rxnSpecies);
0139     
0140     interMat(:,i) = reactants+products;   
0141     
0142     <span class="comment">% error if no products are written in reaction</span>
0143     <span class="keyword">if</span> ~ismember(1,products)
0144         error(<span class="string">'RxnSyntax:NoProducts'</span>, <span class="string">'No products in reaction'</span>);
0145     <span class="keyword">end</span>
0146     
0147     <span class="comment">% If there are no reactants in interMat, but there are letters before</span>
0148     <span class="comment">% =&gt;, then error.</span>
0149     reactantStr = reactionRules{i};
0150     <span class="keyword">if</span> ~ismember(-1,reactants) &amp;&amp; ~isempty(reactantStr(1:eqPos-1))
0151         error(<span class="string">'RxnSyntax:ReactantsNotRecognized'</span>, <span class="string">'Reactants not recognized, may be misspelled'</span>)
0152     <span class="keyword">end</span>
0153     
0154     <span class="comment">% Detect # of attempted reactants from number of '&amp;'s, then compare to actual # of</span>
0155     <span class="comment">% reactants placed in matrix, if they don't match, then error</span>
0156     <span class="keyword">if</span> length(find(reactantStr(1:eqPos-1)==<span class="string">'&amp;'</span>)) + 1 &gt; length(find(reactants == -1)) <span class="keyword">...</span>
0157             &amp;&amp; ~isempty(reactantStr(1:eqPos-1))
0158         error(<span class="string">'RxnSyntax:ReactantsNotRecognized'</span>, <span class="string">'One or more reactants not recognized, make sure all species appear exactly as they are in the species sheet'</span>);
0159     <span class="keyword">end</span>
0160     
0161     <span class="comment">% calculate notMat column for reaction 'i'</span>
0162     notSpecID = cellfun(@(x) [<span class="string">'!'</span>,x],specID,<span class="string">'UniformOutput'</span>,false);
0163     rxnNotSpecies = regexp(reactionRules{i},notSpecID);
0164     notMat(:,i) = cellfun(<span class="string">'isempty'</span>,rxnNotSpecies);
0165     
0166     <span class="keyword">catch</span> err
0167         <span class="keyword">if</span> strcmp(err.identifier, <span class="string">'RxnSyntax:NoSpeciesMatch'</span>)
0168             mismatchErrs{end+1} = sprintf([reactionIDs{i},<span class="string">':'</span>, reactionRules{i}]);
0169             
0170         <span class="keyword">elseif</span> strcmp(err.identifier, <span class="string">'RxnSyntax:NoProducts'</span>)
0171             NoProductsErrs{end+1} = sprintf([reactionIDs{i},<span class="string">':'</span>,reactionRules{i}]);
0172             
0173         <span class="keyword">elseif</span> strcmp(err.identifier, <span class="string">'RxnSyntax:ReactantsNotRecognized'</span>)
0174             NoReactantsErrs{end+1} = sprintf([ reactionIDs{i},<span class="string">':'</span>,reactionRules{i}]);
0175             
0176         <span class="keyword">elseif</span> strcmp(err.identifier, <span class="string">'RxnSyntax:NoReactionArrow'</span>)
0177             ArrowErrs{end+1} = sprintf([ reactionIDs{i},<span class="string">':'</span>,reactionRules{i}]);
0178         <span class="keyword">else</span>
0179             rethrow(err)
0180         <span class="keyword">end</span>
0181     <span class="keyword">end</span>
0182     
0183     <span class="comment">% organize errors into a cell array based on error type for return to</span>
0184     <span class="comment">% the gui, if there are no errors of a certain type, it is not added to</span>
0185     <span class="comment">% the XLSerror cell array.</span>
0186     XLSerror = {};
0187     <span class="keyword">if</span> ~isempty(varError)
0188         XLSerror{end+1} = <span class="string">'Warning: Invalid species name(s):'</span>;
0189         <span class="keyword">for</span> m = 1:length(varError)
0190             XLSerror{end+1} = varError{m};
0191         <span class="keyword">end</span>
0192         XLSerror{end+1} = <span class="string">''</span>;
0193     <span class="keyword">end</span>
0194     <span class="keyword">if</span> ~isempty(mismatchErrs)
0195         XLSerror{end+1} = <span class="string">'Warning: No species recognized:'</span>;
0196         <span class="keyword">for</span> m = 1:length(mismatchErrs)
0197             XLSerror{end+1} = mismatchErrs{m};
0198         <span class="keyword">end</span>
0199         XLSerror{end+1} = <span class="string">''</span>;
0200     <span class="keyword">end</span>
0201     <span class="keyword">if</span> ~isempty(NoProductsErrs)
0202         XLSerror{end+1} = <span class="string">'Warning: Product not recognized'</span>;
0203         <span class="keyword">for</span> m = 1:length(NoProductsErrs)
0204             XLSerror{end+1} = NoProductsErrs{m};
0205         <span class="keyword">end</span>
0206         XLSerror{end+1} = <span class="string">''</span>;
0207     <span class="keyword">end</span>
0208     <span class="keyword">if</span> ~isempty(NoReactantsErrs)
0209         XLSerror{end+1} = <span class="string">'Warning: Reactant(s) not recognized'</span>;
0210         <span class="keyword">for</span> m = 1:length(NoReactantsErrs)
0211             XLSerror{end+1} = NoReactantsErrs{m};
0212         <span class="keyword">end</span>
0213         XLSerror{end+1} = <span class="string">''</span>;
0214     <span class="keyword">end</span>
0215     <span class="keyword">if</span> ~isempty(ArrowErrs)
0216         XLSerror{end+1} = <span class="string">'Warning: No reaction arrow could be identified'</span>;
0217         <span class="keyword">for</span> m = 1:length(ArrowErrs)
0218             XLSerror{end+1} = ArrowErrs{m};
0219         <span class="keyword">end</span>
0220         XLSerror{end+1} = <span class="string">''</span>;
0221     <span class="keyword">end</span>
0222     <span class="keyword">if</span> ~isempty(DuplicateErrs)
0223         XLSerror{end+1} = <span class="string">'Warning: Duplicate reactions detected'</span>;
0224         <span class="keyword">for</span> m = 1:length(DuplicateErrs);
0225             XLSerror{end+1} = DuplicateErrs{m};
0226         <span class="keyword">end</span>
0227         XLSerror{end+1} = <span class="string">''</span>;
0228     <span class="keyword">end</span>     
0229     <span class="keyword">if</span> isempty(XLSerror)
0230         XLSerror = [<span class="string">''</span>];
0231     <span class="keyword">end</span>
0232 <span class="keyword">end</span>
0233 
0234 <span class="comment">% create model structure CNAmodel and then create ODE files via cna2Netflux</span>
0235 CNAmodel.specID = char(specID); <span class="comment">% store specID in a character array</span>
0236 CNAmodel.interMat = interMat;
0237 CNAmodel.notMat = notMat;
0238 CNAmodel.net_var_name = networkID;
0239 CNAmodel.type = speciesSheetTxt(3:<span class="keyword">end</span>, 7);
0240 CNAmodel.location = speciesSheetTxt(3:<span class="keyword">end</span>,8);
0241 CNAmodel.module = speciesSheetTxt(3:<span class="keyword">end</span>, 1);
0242 CNAmodel.ref = speciesSheetTxt(3:<span class="keyword">end</span>, 9);
0243 
0244 <span class="keyword">for</span> i=1:size(CNAmodel.specID,1)
0245     speciesNames{i} = strtrim(CNAmodel.specID(i,:));
0246 <span class="keyword">end</span>
0247 [paramList,ODElist, CNAerror] = util.Netflux2ODE(CNAmodel,xlsfilename);
0248 
0249 <span class="comment">% 2 possible errors one from xls2Netflux and the other from</span>
0250 <span class="comment">% CNA2Netflux, assign each to a cell for return to GUI.</span>
0251 <span class="keyword">if</span> ~isequal(<span class="string">''</span>, XLSerror) &amp;&amp; ~isequal(<span class="string">''</span>,CNAerror)
0252     ReadError = {XLSerror{:}, CNAerror{:}};
0253 <span class="keyword">elseif</span> ~isequal(<span class="string">''</span>, XLSerror)
0254     ReadError = {XLSerror{:}};
0255 <span class="keyword">elseif</span> ~isequal(<span class="string">''</span>, CNAerror)
0256     ReadError = {CNAerror{:}};
0257 <span class="keyword">else</span> 
0258     ReadError = {<span class="string">''</span>,<span class="string">''</span>}; <span class="comment">% only happens when there are no errors</span>
0259 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Thu 07-Aug-2014 13:40:59 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>